<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GARCIA MOBILIDADE - Motorista</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: black; color: white; }
        .screen { display: none; }
        .screen.active { display: block; }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #6d28d9; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ef4444; transition: .4s; border-radius: 24px; }
        .toggle-slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .toggle-slider { background-color: #22c55e; }
        input:checked + .toggle-slider:before { transform: translateX(26px); }

        /* Toast Notifications Styles */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 1000; }
        .toast { 
            background: #1f2937; border-left: 4px solid; color: white; padding: 16px; border-radius: 8px; 
            margin-bottom: 10px; min-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            transform: translateX(400px); transition: all 0.3s ease;
        }
        .toast.show { transform: translateX(0); }
        .toast.success { border-left-color: #22c55e; }
        .toast.error { border-left-color: #ef4444; }
        .toast.info { border-left-color: #3b82f6; }
        .toast.warning { border-left-color: #f59e0b; }

        /* Form Validation Styles */
        .field-error { border-color: #ef4444 !important; }
        .field-valid { border-color: #22c55e !important; }
        .error-message { color: #ef4444; font-size: 0.875rem; margin-top: 4px; }
        .success-message { color: #22c55e; font-size: 0.875rem; margin-top: 4px; }

        /* Loading Button States */
        .btn-loading { position: relative; color: transparent; }
        .btn-loading::after {
            content: ''; position: absolute; top: 50%; left: 50%; width: 20px; height: 20px;
            margin: -10px 0 0 -10px; border: 2px solid #ffffff; border-top: 2px solid transparent;
            border-radius: 50%; animation: spin 1s linear infinite;
        }

        /* Improved Form Field Styles */
        .form-field { position: relative; }
        .form-field input:focus + label { color: #6d28d9; }
        .form-field.has-value label { color: #6d28d9; font-size: 0.875rem; }
        
        /* New Ride Alert Animation */
        @keyframes newRideAlert { 0%, 100% { background-color: #059669; } 50% { background-color: #10b981; } }
        .new-ride-alert { animation: newRideAlert 1s ease-in-out infinite; }

        /* Ride Status Colors */
        .status-requested { color: #fbbf24; }
        .status-assigned { color: #3b82f6; }
        .status-accepted { color: #8b5cf6; }
        .status-arrived_pickup { color: #6366f1; }
        .status-in_progress { color: #10b981; }
        .status-completed { color: #22c55e; }
        .status-cancelled { color: #ef4444; }

        /* DESTINO SUPER HIGHLIGHT - IMPOSS√çVEL DE ESCONDER */
        .destino-super-highlight { 
            color: #00ff00 !important; 
            font-weight: 900 !important; 
            font-size: 1.1em !important;
            background: linear-gradient(45deg, #22c55e, #10b981) !important;
            -webkit-background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
            background-clip: text !important;
            text-shadow: 0 0 10px #22c55e !important;
            border: 2px solid #22c55e !important;
            padding: 4px 8px !important;
            border-radius: 6px !important;
            display: inline-block !important;
            animation: glow 2s infinite alternate !important;
        }

        @keyframes glow {
            from { box-shadow: 0 0 5px #22c55e, 0 0 10px #22c55e; }
            to { box-shadow: 0 0 10px #22c55e, 0 0 20px #22c55e, 0 0 30px #22c55e; }
        }

        /* Loading Error Styles */
        .loading-error {
            background: #1f2937;
            border: 1px solid #ef4444;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <div id="app-container" class="w-full max-w-md mx-auto p-4">

        <div id="loading-screen" class="screen active text-center">
            <div class="loader mx-auto"></div>
            <p class="mt-4">Carregando...</p>
            <div id="loading-error" class="loading-error hidden">
                <p class="text-red-400 mb-2">‚ö†Ô∏è Problema no carregamento</p>
                <p class="text-sm text-gray-400 mb-4">Tentando resolver automaticamente...</p>
                <button onclick="forceReset()" class="w-full py-2 px-4 bg-red-600 hover:bg-red-700 rounded-lg text-white">
                    üîÑ For√ßar Reset
                </button>
            </div>
        </div>

        <div id="login-screen" class="screen space-y-4">
            <img src="images/logogarcia.png" alt="Logo Garcia Transportes" class="mx-auto h-20 w-auto mb-8">
            <h2 class="text-3xl font-bold text-center">√Årea do Motorista</h2>
            <form id="login-form" class="space-y-3">
                <div class="form-field">
                    <label for="login-email" class="block mb-1 text-sm font-medium">E-mail *</label>
                    <input type="email" id="login-email" class="w-full p-2.5 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none focus:border-indigo-500" required>
                    <div id="login-email-error" class="error-message hidden"></div>
                </div>
                <div class="form-field">
                    <label for="login-password" class="block mb-1 text-sm font-medium">Senha *</label>
                    <div class="relative">
                        <input type="password" id="login-password" class="w-full p-2.5 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none focus:border-indigo-500" required>
                        <button type="button" id="toggle-login-password" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white">
                            üëÅÔ∏è
                        </button>
                    </div>
                    <div id="login-password-error" class="error-message hidden"></div>
                </div>
                <button type="submit" id="login-btn" class="w-full py-3 font-semibold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors">
                    ENTRAR
                </button>
            </form>
            <p class="text-center text-sm">Ainda n√£o √© um motorista parceiro? <a href="#" onclick="showScreen('signup-screen')" class="font-semibold text-indigo-400 hover:text-indigo-300">Cadastre-se</a></p>
        </div>

        <div id="signup-screen" class="screen space-y-3">
            <h2 class="text-3xl font-bold text-center">Cadastro de Motorista</h2>
            <form id="signup-form" class="space-y-3">
                <h3 class="text-lg font-semibold border-b border-gray-600 pb-2">Dados Pessoais</h3>
                
                <div class="form-field">
                    <label for="signup-fullname" class="block mb-1 text-sm font-medium">Nome Completo *</label>
                    <input type="text" id="signup-fullname" class="w-full p-2.5 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none focus:border-indigo-500" required>
                    <div id="signup-fullname-error" class="error-message hidden"></div>
                </div>

                <div class="form-field">
                    <label for="signup-email" class="block mb-1 text-sm font-medium">E-mail *</label>
                    <input type="email" id="signup-email" class="w-full p-2.5 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none focus:border-indigo-500" required>
                    <div id="signup-email-error" class="error-message hidden"></div>
                </div>

                <div class="form-field">
                    <label for="signup-phone" class="block mb-1 text-sm font-medium">Telefone * <span class="text-xs text-gray-400">(11) 99999-9999</span></label>
                    <input type="tel" id="signup-phone" placeholder="(11) 99999-9999" class="w-full p-2.5 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none focus:border-indigo-500" required>
                    <div id="signup-phone-error" class="error-message hidden"></div>
                </div>

                <div class="form-field">
                    <label for="signup-password" class="block mb-1 text-sm font-medium">Senha * <span class="text-xs text-gray-400">M√≠n. 6 caracteres</span></label>
                    <div class="relative">
                        <input type="password" id="signup-password" class="w-full p-2.5 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none focus:border-indigo-500" required>
                        <button type="button" id="toggle-signup-password" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white">
                            üëÅÔ∏è
                        </button>
                    </div>
                    <div id="signup-password-error" class="error-message hidden"></div>
                </div>
                
                <h3 class="text-lg font-semibold border-b border-gray-600 pt-4 pb-2">Dados do Ve√≠culo</h3>
                
                <div class="form-field">
                    <label for="signup-plate" class="block mb-1 text-sm font-medium">Placa * <span class="text-xs text-gray-400">ABC-1234</span></label>
                    <input type="text" id="signup-plate" placeholder="ABC-1234" class="w-full p-2.5 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none focus:border-indigo-500" required>
                    <div id="signup-plate-error" class="error-message hidden"></div>
                </div>

                <div class="form-field">
                    <label for="signup-model" class="block mb-1 text-sm font-medium">Modelo *</label>
                    <input type="text" id="signup-model" placeholder="Ex: Honda Civic" class="w-full p-2.5 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none focus:border-indigo-500" required>
                    <div id="signup-model-error" class="error-message hidden"></div>
                </div>

                <div class="form-field">
                    <label for="signup-color" class="block mb-1 text-sm font-medium">Cor *</label>
                    <input type="text" id="signup-color" placeholder="Ex: Branco" class="w-full p-2.5 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none focus:border-indigo-500" required>
                    <div id="signup-color-error" class="error-message hidden"></div>
                </div>

                <button type="submit" id="signup-btn" class="w-full py-3 font-semibold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors !mt-6">
                    ENVIAR CADASTRO
                </button>
            </form>
            <p class="text-center text-sm">J√° tem uma conta? <a href="#" onclick="showScreen('login-screen')" class="font-semibold text-indigo-400 hover:text-indigo-300">Fa√ßa o login</a></p>
        </div>
        
        <div id="pending-approval-screen" class="screen text-center space-y-4">
            <div class="animate-pulse">
                <div class="w-16 h-16 bg-yellow-500 rounded-full mx-auto mb-4 flex items-center justify-center">
                    ‚è≥
                </div>
            </div>
            <h2 class="text-3xl font-bold">Cadastro em An√°lise</h2>
            <p class="text-gray-400">Obrigado por se cadastrar! Seus dados foram enviados e est√£o sendo analisados pela nossa equipe.</p>
            <p class="text-gray-400">Voc√™ ser√° notificado assim que seu cadastro for aprovado.</p>
            <button onclick="handleSignOut()" class="w-full py-3 font-semibold rounded-lg bg-red-600 hover:bg-red-700 transition-colors">
                Sair
            </button>
        </div>

        <div id="driver-screen" class="screen space-y-4">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold">Minhas Corridas</h2>
                <button onclick="handleSignOut()" class="py-2 px-4 text-sm font-semibold rounded-lg bg-red-600 hover:bg-red-700 transition-colors">
                    Sair
                </button>
            </div>
            <p id="driver-welcome-message" class="text-lg text-center"></p>

            <div class="flex items-center justify-between p-3 rounded-lg bg-gray-800">
                <div>
                    <span class="font-semibold text-lg">Ficar Online</span>
                    <p class="text-xs text-gray-400">Receba novas corridas</p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="work-status-toggle" onchange="toggleWorkStatus()">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <button id="silence-btn" onclick="stopRinging()" class="hidden w-full mb-4 py-2 px-4 font-semibold rounded-lg bg-yellow-500 text-gray-900 hover:bg-yellow-600 transition-colors">
                üîá Silenciar Alerta
            </button>
            
            <div id="driver-jobs-list" class="space-y-4">
                <div class="text-center py-8">
                    <div class="loader mx-auto mb-4"></div>
                    <p class="text-gray-400">Carregando corridas...</p>
                </div>
            </div>
        </div>
    </div>
    
    <audio id="ringtone" loop preload="auto" src="https://assets.mixkit.co/sfx/preview/mixkit-bell-notification-933.mp3"></audio>

    <script>
        const SUPABASE_URL = 'https://emhxlsmukcwgukcsxhrr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVtaHhsc211a2N3Z3VrY3N4aHJyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwMjU4NDAsImV4cCI6MjA3NDYwMTg0MH0.iqUWK2wJHuofA76u3wjbT1DBN_m3dqz60vPZ-dF9wYM';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const state = { 
            user: null, 
            profile: null, 
            driverDetails: null, 
            rides: [], 
            rideSubscription: null, 
            locationWatcher: null,
            ridesCache: new Map(),
            isInitializing: false
        };
        let ringInterval = null;
        let locationUpdateTimeout = null;
        let loadingTimeout = null;

        // =============================================================================
        // SISTEMA DE RECUPERA√á√ÉO DE CARREGAMENTO
        // =============================================================================
        function clearCorruptedData() {
            console.log('üßπ Limpando dados corrompidos...');
            try {
                // Limpar localStorage relacionado ao Supabase
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (key.includes('supabase') || key.includes('sb-') || key.includes('auth'))) {
                        keysToRemove.push(key);
                    }
                }
                keysToRemove.forEach(key => {
                    console.log('üóëÔ∏è Removendo:', key);
                    localStorage.removeItem(key);
                });

                // Limpar sessionStorage
                sessionStorage.clear();
                
                console.log('‚úÖ Dados corrompidos limpos');
                return true;
            } catch (error) {
                console.error('‚ùå Erro ao limpar dados:', error);
                return false;
            }
        }

        function setupLoadingTimeout() {
            // Timeout de 10 segundos para carregamento
            loadingTimeout = setTimeout(() => {
                console.log('‚è∞ Timeout de carregamento atingido');
                const loadingError = document.getElementById('loading-error');
                loadingError.classList.remove('hidden');
                
                // Tentar limpar dados automaticamente ap√≥s 3 segundos
                setTimeout(() => {
                    console.log('üîÑ Tentando recupera√ß√£o autom√°tica...');
                    forceReset();
                }, 3000);
            }, 10000);
        }

        function clearLoadingTimeout() {
            if (loadingTimeout) {
                clearTimeout(loadingTimeout);
                loadingTimeout = null;
            }
        }

        function forceReset() {
            console.log('üö® Executando reset for√ßado...');
            clearLoadingTimeout();
            
            // Limpar dados corrompidos
            clearCorruptedData();
            
            // Reset do state
            state.user = null;
            state.profile = null;
            state.driverDetails = null;
            state.rides = [];
            state.isInitializing = false;
            
            // Parar subscriptions
            if (state.rideSubscription) {
                supabaseClient.removeChannel(state.rideSubscription);
                state.rideSubscription = null;
            }
            
            stopLocationTracking();
            
            // Mostrar tela de login
            showScreen('login-screen');
            
            toast.show('Reset executado com sucesso! Fa√ßa login novamente.', 'success');
        }

        // =============================================================================
        // TOAST NOTIFICATION SYSTEM
        // =============================================================================
        class ToastManager {
            constructor() {
                this.container = document.getElementById('toast-container');
                this.toasts = [];
            }

            show(message, type = 'info', duration = 4000) {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <p class="font-medium">${this.getTypeIcon(type)} ${this.getTypeTitle(type)}</p>
                            <p class="text-sm opacity-90 mt-1">${message}</p>
                        </div>
                        <button onclick="this.parentElement.parentElement.remove()" class="ml-3 text-white/60 hover:text-white">
                            ‚úï
                        </button>
                    </div>
                `;

                this.container.appendChild(toast);
                
                setTimeout(() => toast.classList.add('show'), 100);

                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.classList.remove('show');
                        setTimeout(() => toast.remove(), 300);
                    }
                }, duration);

                return toast;
            }

            getTypeIcon(type) {
                const icons = {
                    success: '‚úÖ',
                    error: '‚ùå',
                    warning: '‚ö†Ô∏è',
                    info: '‚ÑπÔ∏è'
                };
                return icons[type] || icons.info;
            }

            getTypeTitle(type) {
                const titles = {
                    success: 'Sucesso',
                    error: 'Erro',
                    warning: 'Aten√ß√£o',
                    info: 'Informa√ß√£o'
                };
                return titles[type] || titles.info;
            }
        }

        const toast = new ToastManager();

        // =============================================================================
        // FORM VALIDATION SYSTEM
        // =============================================================================
        class FormValidator {
            constructor() {
                this.rules = {
                    email: {
                        pattern: /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
                        message: 'Digite um e-mail v√°lido'
                    },
                    phone: {
                        pattern: /^\(\d{2}\)\s\d{4,5}-\d{4}$/,
                        message: 'Digite um telefone v√°lido (11) 99999-9999'
                    },
                    plate: {
                        pattern: /^[A-Z]{3}-\d{4}$/,
                        message: 'Digite uma placa v√°lida ABC-1234'
                    },
                    password: {
                        minLength: 6,
                        message: 'A senha deve ter pelo menos 6 caracteres'
                    },
                    required: {
                        message: 'Este campo √© obrigat√≥rio'
                    }
                };
            }

            validateField(field, value) {
                const errors = [];
                
                if (field.hasAttribute('required') && !value.trim()) {
                    errors.push(this.rules.required.message);
                    return errors;
                }

                if (!value.trim()) return errors;

                const fieldType = field.type;
                const fieldId = field.id;

                if (fieldType === 'email' && !this.rules.email.pattern.test(value)) {
                    errors.push(this.rules.email.message);
                }

                if (fieldId.includes('phone') && !this.rules.phone.pattern.test(value)) {
                    errors.push(this.rules.phone.message);
                }

                if (fieldId.includes('plate') && !this.rules.plate.pattern.test(value.toUpperCase())) {
                    errors.push(this.rules.plate.message);
                }

                if (fieldType === 'password' && value.length < this.rules.password.minLength) {
                    errors.push(this.rules.password.message);
                }

                if (fieldId.includes('fullname') && value.trim().split(' ').length < 2) {
                    errors.push('Digite o nome completo');
                }

                return errors;
            }

            showFieldError(fieldId, errors) {
                const field = document.getElementById(fieldId);
                const errorDiv = document.getElementById(fieldId + '-error');
                
                if (errors.length > 0) {
                    field.classList.add('field-error');
                    field.classList.remove('field-valid');
                    errorDiv.textContent = errors[0];
                    errorDiv.classList.remove('hidden');
                } else {
                    field.classList.remove('field-error');
                    field.classList.add('field-valid');
                    errorDiv.classList.add('hidden');
                }
            }

            validateForm(formId) {
                const form = document.getElementById(formId);
                const fields = form.querySelectorAll('input[required], input[type="email"], input[type="password"]');
                let isValid = true;

                fields.forEach(field => {
                    const errors = this.validateField(field, field.value);
                    this.showFieldError(field.id, errors);
                    if (errors.length > 0) isValid = false;
                });

                return isValid;
            }
        }

        const validator = new FormValidator();

        // =============================================================================
        // UTILITY FUNCTIONS
        // =============================================================================
        function validateEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function getAuthErrorMessage(error) {
            const errorMessages = {
                'Invalid login credentials': 'E-mail ou senha incorretos',
                'Email not confirmed': 'Confirme seu e-mail antes de fazer login',
                'Too many requests': 'Muitas tentativas de login. Tente novamente em alguns minutos',
                'User not found': 'Usu√°rio n√£o encontrado',
                'Invalid email': 'E-mail inv√°lido',
                'Weak password': 'Senha muito fraca',
                'signup_disabled': 'Cadastros desabilitados temporariamente'
            };
            
            for (const [key, message] of Object.entries(errorMessages)) {
                if (error.message.includes(key)) {
                    return message;
                }
            }
            
            return 'Erro: ' + error.message;
        }

        // =============================================================================
        // INPUT MASKS
        // =============================================================================
        function applyPhoneMask(input) {
            input.addEventListener('input', (e) => {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length <= 11) {
                    if (value.length <= 2) {
                        value = value.replace(/(\d{0,2})/, '($1');
                    } else if (value.length <= 6) {
                        value = value.replace(/(\d{2})(\d{0,4})/, '($1) $2');
                    } else if (value.length <= 10) {
                        value = value.replace(/(\d{2})(\d{4})(\d{0,4})/, '($1) $2-$3');
                    } else {
                        value = value.replace(/(\d{2})(\d{5})(\d{0,4})/, '($1) $2-$3');
                    }
                }
                e.target.value = value;
            });
        }

        function applyPlateMask(input) {
            input.addEventListener('input', (e) => {
                let value = e.target.value.replace(/[^a-zA-Z0-9]/g, '').toUpperCase();
                if (value.length <= 7) {
                    if (value.length <= 3) {
                        value = value.replace(/([A-Z]{0,3})/, '$1');
                    } else {
                        value = value.replace(/([A-Z]{3})([0-9]{0,4})/, '$1-$2');
                    }
                }
                e.target.value = value;
            });
        }

        // =============================================================================
        // UTILITY FUNCTIONS
        // =============================================================================
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            
            // Limpar timeout quando mudar de tela
            clearLoadingTimeout();
        }

        function showLoading(buttonId) {
            const button = document.getElementById(buttonId);
            button.classList.add('btn-loading');
            button.disabled = true;
        }

        function hideLoading(buttonId) {
            const button = document.getElementById(buttonId);
            button.classList.remove('btn-loading');
            button.disabled = false;
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // =============================================================================
        // FUN√á√ÉO PARA EXTRAIR DADOS DO DESTINO - CORRIGIDA PARA ARRAY DE STRINGS
        // =============================================================================
        function getDestinationInfo(ride) {
            console.log('üî• DEBUG DESTINO ARRAY STRINGS - Analisando corrida:', ride.id);
            console.log('üî• ride.destinations (tipo):', typeof ride.destinations);
            console.log('üî• ride.destinations (valor):', ride.destinations);
            console.log('üî• ride.destinations (JSON):', JSON.stringify(ride.destinations));
            
            // M√©todo 1: destinations como JSONB Array de Strings
            if (ride.destinations) {
                console.log('üéØ VERIFICANDO destinations...');
                
                // Se destinations j√° √© um array JavaScript (Supabase converte JSONB automaticamente)
                if (Array.isArray(ride.destinations) && ride.destinations.length > 0) {
                    const firstDestination = ride.destinations[0];
                    console.log('üéØ PRIMEIRO ITEM destinations[0]:', firstDestination);
                    console.log('üéØ TIPO do primeiro item:', typeof firstDestination);
                    
                    // Se o primeiro item √© uma STRING (formato correto baseado na imagem)
                    if (typeof firstDestination === 'string' && firstDestination.trim() !== '') {
                        console.log('‚úÖ DESTINO ENCONTRADO (string direta):', firstDestination);
                        return firstDestination.trim();
                    }
                    
                    // Se ainda for um objeto (fallback)
                    if (typeof firstDestination === 'object' && firstDestination !== null) {
                        console.log('üéØ Primeiro item √© objeto:', firstDestination);
                        if (firstDestination.address) {
                            console.log('‚úÖ DESTINO OBJETO.address:', firstDestination.address);
                            return firstDestination.address;
                        }
                        if (firstDestination.name) {
                            console.log('‚úÖ DESTINO OBJETO.name:', firstDestination.name);
                            return firstDestination.name;
                        }
                    }
                }
                
                // Se destinations √© um objeto √∫nico (n√£o array)
                if (typeof ride.destinations === 'object' && !Array.isArray(ride.destinations) && ride.destinations !== null) {
                    console.log('üéØ destinations √© objeto √∫nico:', ride.destinations);
                    
                    if (typeof ride.destinations === 'string') {
                        console.log('‚úÖ DESTINO STRING OBJETO:', ride.destinations);
                        return ride.destinations.trim();
                    }
                    
                    if (ride.destinations.address) {
                        console.log('‚úÖ DESTINO OBJETO.address √∫nico:', ride.destinations.address);
                        return ride.destinations.address;
                    }
                    if (ride.destinations.name) {
                        console.log('‚úÖ DESTINO OBJETO.name √∫nico:', ride.destinations.name);
                        return ride.destinations.name;
                    }
                }
                
                // Se destinations ainda √© string JSON (backup)
                if (typeof ride.destinations === 'string' && ride.destinations.trim() !== '') {
                    console.log('üéØ destinations √© STRING, tentando parse:', ride.destinations);
                    
                    try {
                        const parsed = JSON.parse(ride.destinations);
                        console.log('üéØ PARSED JSON resultado:', parsed);
                        
                        if (Array.isArray(parsed) && parsed.length > 0) {
                            const firstParsed = parsed[0];
                            console.log('üéØ Primeiro item parseado:', firstParsed, 'tipo:', typeof firstParsed);
                            
                            // Se √© string direta (esperado baseado na imagem)
                            if (typeof firstParsed === 'string' && firstParsed.trim() !== '') {
                                console.log('‚úÖ DESTINO STRING PARSEADA:', firstParsed);
                                return firstParsed.trim();
                            }
                            
                            // Se √© objeto (fallback)
                            if (typeof firstParsed === 'object' && firstParsed !== null) {
                                if (firstParsed.address) {
                                    console.log('‚úÖ DESTINO PARSEADO.address:', firstParsed.address);
                                    return firstParsed.address;
                                }
                                if (firstParsed.name) {
                                    console.log('‚úÖ DESTINO PARSEADO.name:', firstParsed.name);
                                    return firstParsed.name;
                                }
                            }
                        }
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Erro no parse JSON destinations:', e);
                        // Se o parse falhou, pode ser que seja uma string simples
                        if (ride.destinations.trim() !== '') {
                            console.log('‚úÖ USANDO destinations como string direta:', ride.destinations);
                            return ride.destinations.trim();
                        }
                    }
                }
            }
            
            // M√©todo 2: destination_address (campo separado)
            if (ride.destination_address && typeof ride.destination_address === 'string' && ride.destination_address.trim() !== '') {
                console.log('‚úÖ ENCONTRADO em destination_address:', ride.destination_address);
                return ride.destination_address.trim();
            }
            
            // M√©todo 3: destination_location
            if (ride.destination_location && typeof ride.destination_location === 'string' && ride.destination_location.trim() !== '') {
                console.log('‚úÖ ENCONTRADO em destination_location:', ride.destination_location);
                return 'Coordenadas: ' + ride.destination_location.trim();
            }
            
            console.error('üö® NENHUM DESTINO ENCONTRADO para corrida:', ride.id);
            console.log('üö® DUMP COMPLETO DA CORRIDA:');
            console.log(JSON.stringify(ride, null, 2));
            
            return 'Destino n√£o especificado';
        }

        // =============================================================================
        // AUTHENTICATION FUNCTIONS
        // =============================================================================
        async function handleSignUp(formData) {
            if (!validator.validateForm('signup-form')) {
                toast.show('Por favor, corrija os erros no formul√°rio', 'error');
                return;
            }

            showLoading('signup-btn');

            try {
                const { data: authData, error: authError } = await supabaseClient.auth.signUp({
                    email: formData.email, 
                    phone: formData.phone, 
                    password: formData.password,
                    options: { data: { full_name: formData.fullName, user_type: 'driver' } }
                });

                if (authError) {
                    toast.show(getAuthErrorMessage(authError), 'error');
                    return;
                }

                if (!authData.user) {
                    toast.show('N√£o foi poss√≠vel criar o usu√°rio. Tente novamente.', 'error');
                    return;
                }

                const { error: detailsError } = await supabaseClient.from('driver_details').insert({
                    profile_id: authData.user.id, 
                    license_plate: formData.plate, 
                    car_model: formData.model, 
                    car_color: formData.color, 
                    approval_status: 'pending'
                });

                if (detailsError) {
                    toast.show('Erro ao salvar detalhes do ve√≠culo: ' + detailsError.message, 'error');
                    return;
                }

                toast.show('Cadastro enviado com sucesso! Sua conta est√° em an√°lise.', 'success');
                await supabaseClient.auth.signOut();
                showScreen('login-screen');

            } catch (error) {
                toast.show('Erro inesperado: ' + error.message, 'error');
            } finally {
                hideLoading('signup-btn');
            }
        }

        async function handleSignIn(email, password) {
            if (!email || !password) {
                toast.show('Preencha todos os campos', 'warning');
                return;
            }

            if (!validateEmail(email)) {
                toast.show('Digite um e-mail v√°lido', 'error');
                return;
            }

            showLoading('login-btn');

            try {
                console.log('Tentando fazer login com:', email);
                
                const { data, error } = await supabaseClient.auth.signInWithPassword({ 
                    email, 
                    password 
                });
                
                if (error) {
                    console.error('Erro de autentica√ß√£o:', error);
                    toast.show(getAuthErrorMessage(error), 'error');
                    return;
                }

                if (data?.user) {
                    console.log('Login bem-sucedido:', data.user);
                    toast.show('Login realizado com sucesso!', 'success');
                    state.user = data.user;
                    await loadDriverData(data.user.id);
                } else {
                    toast.show('Dados de login inv√°lidos', 'error');
                }
                
            } catch (error) {
                console.error('Erro inesperado no login:', error);
                toast.show('Erro inesperado: ' + error.message, 'error');
            } finally {
                hideLoading('login-btn');
            }
        }

        async function handleSignOut() {
            try {
                if (state.rideSubscription) {
                    await supabaseClient.removeChannel(state.rideSubscription);
                    state.rideSubscription = null;
                }
                stopLocationTracking();
                if (state.user && state.driverDetails) {
                    await supabaseClient.from('driver_details').update({ work_status: 'offline' }).eq('profile_id', state.user.id);
                }
                
                // Limpar dados de sess√£o
                clearCorruptedData();
                
                await supabaseClient.auth.signOut();
                toast.show('Logout realizado com sucesso', 'success');
                
                // Reset do state
                state.user = null;
                state.profile = null;
                state.driverDetails = null;
                state.rides = [];
                state.isInitializing = false;
                
            } catch (error) {
                toast.show('Erro ao fazer logout: ' + error.message, 'error');
                // Force reset mesmo se logout falhar
                forceReset();
            }
        }

        async function checkSession() {
            if (state.isInitializing) {
                console.log('‚è≥ J√° inicializando, aguardando...');
                return;
            }
            
            state.isInitializing = true;
            setupLoadingTimeout();
            
            try {
                console.log('üîç Verificando sess√£o...');
                const { data: { session }, error } = await supabaseClient.auth.getSession();
                
                if (error) {
                    console.error('‚ùå Erro ao verificar sess√£o:', error);
                    throw error;
                }
                
                if (session?.user) {
                    console.log('‚úÖ Sess√£o encontrada:', session.user.id);
                    state.user = session.user;
                    await loadDriverData(session.user.id);
                } else {
                    console.log('‚ÑπÔ∏è Nenhuma sess√£o ativa');
                    clearLoadingTimeout();
                    showScreen('login-screen');
                }
            } catch (error) { 
                console.error("‚ùå Erro cr√≠tico ao verificar sess√£o:", error);
                
                // Tentar limpeza autom√°tica
                const cleaned = clearCorruptedData();
                if (cleaned) {
                    toast.show('Dados corrompidos detectados e limpos. Fa√ßa login novamente.', 'warning');
                } else {
                    toast.show('Erro ao verificar sess√£o. Tente fazer login.', 'error');
                }
                
                clearLoadingTimeout();
                showScreen('login-screen');
            } finally {
                state.isInitializing = false;
            }
        }
        
        async function loadDriverData(userId) {
            try {
                console.log('üìä Carregando dados do motorista:', userId);
                
                const { data: profileData, error: profileError } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('id', userId)
                    .single();

                if (profileError || !profileData || profileData.user_type !== 'driver') {
                    console.error('‚ùå Perfil de motorista n√£o encontrado:', profileError?.message);
                    toast.show('Perfil de motorista n√£o encontrado. Verifique se voc√™ se cadastrou como motorista.', 'error');
                    clearLoadingTimeout();
                    return handleSignOut();
                }
                
                console.log('‚úÖ Perfil encontrado:', profileData.full_name);
                state.profile = profileData;

                const { data: driverDetailsData, error: driverDetailsError } = await supabaseClient
                    .from('driver_details')
                    .select('*')
                    .eq('profile_id', userId)
                    .single();

                if (driverDetailsError || !driverDetailsData) {
                    console.log('‚ö†Ô∏è Detalhes do motorista n√£o encontrados, definindo como pendente');
                    state.driverDetails = { approval_status: 'pending' };
                } else {
                    console.log('‚úÖ Detalhes do motorista carregados');
                    state.driverDetails = driverDetailsData;
                }

                document.getElementById('driver-welcome-message').textContent = `Ol√°, ${state.profile.full_name}!`;

                clearLoadingTimeout();

                if (state.driverDetails.approval_status === 'approved') {
                    console.log('‚úÖ Motorista aprovado, carregando tela principal');
                    showScreen('driver-screen');
                    updateWorkStatusToggle();
                    await loadDriverJobs();
                    subscribeToRides();
                } else {
                    console.log('‚è≥ Motorista pendente de aprova√ß√£o');
                    showScreen('pending-approval-screen');
                }
            } catch (error) {
                console.error('‚ùå Erro cr√≠tico ao carregar dados do motorista:', error);
                toast.show('Erro ao carregar dados do motorista. Tentando novamente...', 'error');
                clearLoadingTimeout();
                
                // Tentar reset ap√≥s erro cr√≠tico
                setTimeout(() => {
                    forceReset();
                }, 2000);
            }
        }

        // =============================================================================
        // RIDE MANAGEMENT
        // =============================================================================
        function subscribeToRides() {
            if (state.rideSubscription) {
                supabaseClient.removeChannel(state.rideSubscription);
            }

            state.rideSubscription = supabaseClient
                .channel('public:rides')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'rides' }, payload => {
                    console.log('Mudan√ßa recebida!', payload);
                    handleRideChange(payload);
                })
                .subscribe(status => {
                    if (status === 'SUBSCRIBED') {
                        console.log('Conectado ao canal de corridas!');
                        toast.show('Conectado ao sistema de corridas', 'success', 2000);
                    }
                });
        }

        async function handleRideChange(payload) {
            const { eventType, new: newRecord, old: oldRecord } = payload;
            
            switch (eventType) {
                case 'INSERT':
                    if (newRecord.status === 'requested' && !newRecord.driver_id) {
                        await addRideToList(newRecord);
                        startRinging();
                        toast.show('Nova corrida dispon√≠vel!', 'info');
                    }
                    break;
                case 'UPDATE':
                    await updateRideInList(newRecord);
                    break;
                case 'DELETE':
                    removeRideFromList(oldRecord.id);
                    break;
                default:
                    await loadDriverJobs();
            }
        }

        async function addRideToList(ride) {
            if (!ride.passenger) {
                const { data: passengerData } = await supabaseClient
                    .from('profiles')
                    .select('full_name, phone_number')
                    .eq('id', ride.passenger_id)
                    .single();
                ride.passenger = passengerData;
            }

            state.rides.unshift(ride);
            state.ridesCache.set(ride.id, ride);
            renderSingleRide(ride, 'prepend');
        }

        async function updateRideInList(ride) {
            const rideIndex = state.rides.findIndex(r => r.id === ride.id);
            if (rideIndex !== -1) {
                state.rides[rideIndex] = { ...state.rides[rideIndex], ...ride };
                state.ridesCache.set(ride.id, state.rides[rideIndex]);
                
                const rideElement = document.querySelector(`[data-ride-id="${ride.id}"]`);
                if (rideElement) {
                    const updatedElement = createRideElement(state.rides[rideIndex]);
                    rideElement.replaceWith(updatedElement);
                }
            } else {
                await loadDriverJobs();
            }
        }

        function removeRideFromList(rideId) {
            state.rides = state.rides.filter(r => r.id !== rideId);
            state.ridesCache.delete(rideId);
            const rideElement = document.querySelector(`[data-ride-id="${rideId}"]`);
            if (rideElement) {
                rideElement.remove();
            }
        }

        function renderSingleRide(ride, position = 'append') {
            const list = document.getElementById('driver-jobs-list');
            const rideElement = createRideElement(ride);
            
            if (position === 'prepend') {
                list.insertBefore(rideElement, list.firstChild);
            } else {
                list.appendChild(rideElement);
            }
        }

        // =============================================================================
        // FUN√á√ÉO PARA CRIAR ELEMENTO DE CORRIDA - CORRIGIDA PARA STRINGS
        // =============================================================================
        function createRideElement(ride) {
            console.log('üî• CRIANDO ELEMENTO - Corrida ID:', ride.id);
            
            const passenger = ride.passenger;
            let actionButton = '';
            let statusColor = '';
            let cardClass = '';

            // OBTER DESTINO COM NOVA FUN√á√ÉO
            let destinationText = getDestinationInfo(ride);
            console.log('üî• DESTINO OBTIDO:', destinationText);
            
            // Se ainda est√° vazio, for√ßar um valor
            if (!destinationText || destinationText.trim() === '') {
                destinationText = 'üö® DESTINO N√ÉO ENCONTRADO üö®';
                console.error('üö® DESTINO VAZIO FOR√áADO PARA:', destinationText);
            }

            switch (ride.status) {
                case 'requested':
                    actionButton = `<button onclick="acceptRide('${ride.id}')" class="w-full py-2 px-4 font-semibold rounded-lg bg-green-600 hover:bg-green-700 transition-colors new-ride-alert">üöó ACEITAR NOVA CORRIDA</button>`;
                    statusColor = 'status-requested';
                    cardClass = 'border-yellow-500';
                    break;
                case 'assigned':
                    actionButton = `<button onclick="updateRideStatus('${ride.id}', 'accepted')" class="w-full py-2 px-4 font-semibold rounded-lg bg-blue-600 hover:bg-blue-700 transition-colors">üìç CHEGUEI AO LOCAL DE PARTIDA</button>`;
                    statusColor = 'status-assigned';
                    cardClass = 'border-blue-500';
                    break;
                case 'accepted':
                    actionButton = `<button onclick="updateRideStatus('${ride.id}', 'arrived_pickup')" class="w-full py-2 px-4 font-semibold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors">üöÄ INICIAR VIAGEM</button>`;
                    statusColor = 'status-accepted';
                    cardClass = 'border-indigo-500';
                    break;
                case 'arrived_pickup':
                    actionButton = `<button onclick="updateRideStatus('${ride.id}', 'in_progress')" class="w-full py-2 px-4 font-semibold rounded-lg bg-purple-600 hover:bg-purple-700 transition-colors">üèÅ FINALIZAR VIAGEM</button>`;
                    statusColor = 'status-arrived_pickup';
                    cardClass = 'border-purple-500';
                    break;
                case 'in_progress':
                    actionButton = `<button onclick="updateRideStatus('${ride.id}', 'completed')" class="w-full py-2 px-4 font-semibold rounded-lg bg-green-600 hover:bg-green-700 transition-colors">‚úÖ VIAGEM CONCLU√çDA</button>`;
                    statusColor = 'status-in_progress';
                    cardClass = 'border-green-500';
                    break;
                case 'completed':
                    statusColor = 'status-completed';
                    cardClass = 'border-green-500 opacity-75';
                    break;
                case 'cancelled':
                    statusColor = 'status-cancelled';
                    cardClass = 'border-red-500 opacity-75';
                    break;
            }

            const div = document.createElement('div');
            div.className = `p-4 rounded-lg bg-gray-800 border-2 ${cardClass} space-y-2 transition-all`;
            div.setAttribute('data-ride-id', ride.id);
            
            // HTML com destino SUPER DESTACADO
            div.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <p><strong>üë§ Passageiro:</strong> ${passenger?.full_name || 'N/A'}</p>
                    <span class="text-xs px-2 py-1 rounded-full bg-gray-700 ${statusColor}">${ride.status.toUpperCase().replace('_', ' ')}</span>
                </div>
                <p><strong>üìû Telefone:</strong> ${passenger?.phone_number || 'N/A'}</p>
                <p><strong>üè† Origem:</strong> ${ride.origin_address || ride.origin_location || 'Origem n√£o especificada'}</p>
                <div style="background: #1f2937; border: 2px solid #22c55e; border-radius: 8px; padding: 8px; margin: 8px 0;">
                    <p style="margin: 0;"><strong style="color: #fbbf24;">üìç DESTINO:</strong> <span class="destino-super-highlight">${destinationText}</span></p>
                </div>
                ${actionButton}
                ${ride.status !== 'completed' && ride.status !== 'cancelled' ? 
                    `<button onclick="openMap('${ride.origin_location || ''}', '${destinationText}')" class="w-full py-2 px-4 font-semibold rounded-lg bg-gray-600 hover:bg-gray-700 transition-colors mt-2">
                        üó∫Ô∏è VER NO MAPA
                    </button>` : ''
                }
            `;
            
            console.log('üî• ELEMENTO CRIADO COM DESTINO:', destinationText);
            return div;
        }
        
        async function toggleWorkStatus() {
            const toggle = document.getElementById('work-status-toggle');
            const isChecked = toggle.checked;
            const newStatus = isChecked ? 'online' : 'offline';
            
            try {
                const { error } = await supabaseClient
                    .from('driver_details')
                    .update({ work_status: newStatus })
                    .eq('profile_id', state.user.id);

                if (error) {
                    toast.show('Erro ao atualizar status: ' + error.message, 'error');
                    toggle.checked = !isChecked;
                } else {
                    state.driverDetails.work_status = newStatus;
                    if (newStatus === 'online') {
                        startLocationTracking();
                        toast.show('Agora voc√™ est√° online para receber corridas!', 'success');
                    } else {
                        stopLocationTracking();
                        toast.show('Voc√™ est√° offline. N√£o receber√° novas corridas.', 'info');
                    }
                }
            } catch (error) {
                toast.show('Erro inesperado: ' + error.message, 'error');
                toggle.checked = !isChecked;
            }
        }

        const updateLocationDebounced = debounce(async (latitude, longitude) => {
            const location = `POINT(${longitude} ${latitude})`;
            const { error } = await supabaseClient
                .from('driver_details')
                .update({ current_location: location })
                .eq('profile_id', state.user.id);
            
            if (error) {
                console.error('Erro ao atualizar localiza√ß√£o:', error.message);
            }
        }, 5000);

        function startLocationTracking() {
            if (!navigator.geolocation) {
                toast.show('Geolocaliza√ß√£o n√£o suportada pelo seu navegador', 'warning');
                return;
            }
            if (state.locationWatcher) return;

            state.locationWatcher = navigator.geolocation.watchPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    updateLocationDebounced(latitude, longitude);
                },
                (error) => {
                    console.error('Erro no rastreamento:', error.message);
                    toast.show('Erro ao obter localiza√ß√£o. Verifique as permiss√µes.', 'error');
                    stopLocationTracking();
                },
                { enableHighAccuracy: true, timeout: 15000, maximumAge: 30000 }
            );
        }

        function stopLocationTracking() {
            if (state.locationWatcher) {
                navigator.geolocation.clearWatch(state.locationWatcher);
                state.locationWatcher = null;
                console.log('Rastreamento parado.');
            }
        }
        
        function updateWorkStatusToggle() {
            if (!state.driverDetails) return;
            const toggle = document.getElementById('work-status-toggle');
            toggle.checked = state.driverDetails.work_status === 'online';
            if (toggle.checked) {
                startLocationTracking();
            } else {
                stopLocationTracking();
            }
        }

        async function loadDriverJobs() {
            if (!state.user) return;
            const list = document.getElementById('driver-jobs-list');
            
            try {
                list.innerHTML = `
                    <div class="text-center py-8">
                        <div class="loader mx-auto mb-4"></div>
                        <p class="text-gray-400">Carregando corridas...</p>
                    </div>
                `;

                console.log('üîÑ Buscando corridas do motorista...');

                const { data: assignedRides, error: assignedError } = await supabaseClient
                    .from('rides')
                    .select(`
                        *, 
                        passenger:profiles!rides_passenger_id_fkey(full_name, phone_number)
                    `)
                    .eq('driver_id', state.user.id)
                    .in('status', ['assigned', 'accepted', 'arrived_pickup', 'in_progress']);

                const { data: requestedRides, error: requestedError } = await supabaseClient
                    .from('rides')
                    .select(`
                        *, 
                        passenger:profiles!rides_passenger_id_fkey(full_name, phone_number)
                    `)
                    .eq('status', 'requested')
                    .is('driver_id', null);
                    
                if (assignedError || requestedError) {
                    console.error("‚ùå Erro ao buscar corridas:", assignedError || requestedError);
                    list.innerHTML = `
                        <div class="text-center py-8">
                            <p class="text-red-500 mb-4">‚ùå Erro ao carregar corridas</p>
                            <button onclick="loadDriverJobs()" class="px-4 py-2 bg-indigo-600 rounded-lg">
                                Tentar novamente
                            </button>
                        </div>
                    `;
                    return;
                }

                state.rides = [...(assignedRides || []), ...(requestedRides || [])];
                
                console.log('‚úÖ Corridas carregadas:', state.rides.length);
                console.log('üìä Dados das corridas:', state.rides);
                
                state.ridesCache.clear();
                state.rides.forEach(ride => state.ridesCache.set(ride.id, ride));

                if (state.rides.length === 0) {
                    list.innerHTML = `
                        <div class="text-center py-8">
                            <div class="text-6xl mb-4">üöó</div>
                            <p class="text-gray-400">Nenhuma corrida dispon√≠vel no momento</p>
                            <p class="text-sm text-gray-500 mt-2">Mantenha-se online para receber novas corridas</p>
                        </div>
                    `;
                    stopRinging();
                    return;
                }
                
                const hasNewRequestedJob = state.rides.some(r => r.status === 'requested' && r.driver_id === null);
                if (hasNewRequestedJob) {
                    startRinging();
                    toast.show(`${state.rides.filter(r => r.status === 'requested').length} nova(s) corrida(s) dispon√≠vel(is)!`, 'info');
                } else {
                    stopRinging();
                }

                list.innerHTML = '';
                state.rides.forEach(ride => renderSingleRide(ride));

            } catch (error) {
                console.error('‚ùå Erro ao carregar corridas:', error);
                toast.show('Erro ao carregar corridas: ' + error.message, 'error');
                list.innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-red-500 mb-4">‚ùå Erro inesperado</p>
                        <button onclick="loadDriverJobs()" class="px-4 py-2 bg-indigo-600 rounded-lg">
                            Tentar novamente
                        </button>
                    </div>
                `;
            }
        }

        async function acceptRide(rideId) {
            try {
                const { error } = await supabaseClient
                    .from('rides')
                    .update({ driver_id: state.user.id, status: 'assigned' })
                    .eq('id', rideId);

                if (error) {
                    toast.show('Erro ao aceitar corrida: ' + error.message, 'error');
                } else {
                    toast.show('Corrida aceita com sucesso! üöó', 'success');
                }
            } catch (error) {
                console.error(error);
                toast.show('Erro inesperado: ' + error.message, 'error');
            }
        }

        async function updateRideStatus(rideId, newStatus) {
            try {
                const { error } = await supabaseClient
                    .from('rides')
                    .update({ status: newStatus })
                    .eq('id', rideId);

                if (error) {
                    toast.show('Erro ao atualizar status: ' + error.message, 'error');
                } else {
                    const statusMessages = {
                        accepted: 'Status atualizado: No local de partida üìç',
                        arrived_pickup: 'Viagem iniciada! üöÄ',
                        in_progress: 'A caminho do destino üõ£Ô∏è',
                        completed: 'Viagem conclu√≠da com sucesso! ‚úÖ'
                    };
                    toast.show(statusMessages[newStatus] || 'Status atualizado!', 'success');
                }
            } catch (error) {
                console.error(error);
                toast.show('Erro inesperado: ' + error.message, 'error');
            }
        }

        function openMap(originLocation, destinationAddress) {
            try {
                if (!originLocation || !destinationAddress) {
                    toast.show('Localiza√ß√£o n√£o dispon√≠vel para navega√ß√£o', 'warning');
                    return;
                }
                
                const [lng, lat] = originLocation.replace('POINT(', '').replace(')', '').split(' ').map(Number);
                const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${lat},${lng}&destination=${encodeURIComponent(destinationAddress)}&travelmode=driving`;
                window.open(googleMapsUrl, '_blank');
            } catch (error) {
                toast.show('Erro ao abrir o mapa', 'error');
                console.error('Erro no mapa:', error);
            }
        }

        function startRinging() {
            const ringtone = document.getElementById('ringtone');
            const silenceBtn = document.getElementById('silence-btn');
            if (ringtone && ringtone.paused) {
                ringtone.play().catch(e => console.error("Erro ao tocar √°udio:", e));
                silenceBtn.classList.remove('hidden');
            }
        }

        function stopRinging() {
            const ringtone = document.getElementById('ringtone');
            const silenceBtn = document.getElementById('silence-btn');
            if (ringtone && !ringtone.paused) {
                ringtone.pause();
                ringtone.currentTime = 0;
                silenceBtn.classList.add('hidden');
            }
        }

        // =============================================================================
        // INITIALIZATION
        // =============================================================================
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Aplicativo inicializando...');

            supabaseClient.auth.onAuthStateChange(async (event, session) => {
                console.log('üîê Auth event:', event, session?.user?.id);
                
                if (event === 'SIGNED_IN' && session?.user) {
                    if (!state.user) {
                        state.user = session.user;
                        await loadDriverData(session.user.id);
                    }
                } else if (event === 'SIGNED_OUT') {
                    state.user = null;
                    state.profile = null;
                    state.driverDetails = null;
                    state.rides = [];
                    state.isInitializing = false;
                    if (state.rideSubscription) {
                        await supabaseClient.removeChannel(state.rideSubscription);
                        state.rideSubscription = null;
                    }
                    stopLocationTracking();
                    clearLoadingTimeout();
                    showScreen('login-screen');
                }
            });

            document.getElementById('login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const email = e.target.elements['login-email'].value;
                const password = e.target.elements['login-password'].value;
                handleSignIn(email, password);
            });

            document.getElementById('signup-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const formData = {
                    fullName: e.target.elements['signup-fullname'].value,
                    email: e.target.elements['signup-email'].value,
                    phone: e.target.elements['signup-phone'].value,
                    password: e.target.elements['signup-password'].value,
                    plate: e.target.elements['signup-plate'].value,
                    model: e.target.elements['signup-model'].value,
                    color: e.target.elements['signup-color'].value
                };
                handleSignUp(formData);
            });

            document.getElementById('toggle-login-password').addEventListener('click', () => togglePassword('login-password'));
            document.getElementById('toggle-signup-password').addEventListener('click', () => togglePassword('signup-password'));

            applyPhoneMask(document.getElementById('signup-phone'));
            applyPlateMask(document.getElementById('signup-plate'));

            // Verificar sess√£o com delay para dar tempo do Supabase carregar
            setTimeout(checkSession, 1500);
        });

        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const button = document.getElementById(`toggle-${inputId}`);
            
            if (input.type === 'password') {
                input.type = 'text';
                button.textContent = 'üôà';
            } else {
                input.type = 'password';
                button.textContent = 'üëÅÔ∏è';
            }
        }
    </script>
</body>
</html>