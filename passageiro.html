<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GARCIA MOBILIDADE - Passageiro</title>
    
    <!-- CDNs Externos com Fallbacks -->
    <script src="https://cdn.tailwindcss.com" onerror="handleCDNError('tailwind')"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" onerror="handleCDNError('supabase')"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyADSCUHjzyFUwjfcui_lk6vDSQ3PU0bu7g&libraries=places&callback=initGoogleMaps" async defer onerror="handleCDNError('maps')"></script>
    <script src="https://js.stripe.com/v3/" onerror="handleCDNError('stripe')"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { 
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background-color: #000000; 
            color: #ffffff; 
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        .screen { display: none; }
        .screen.active { display: block; }
        
        .loader { 
            border: 4px solid #f3f3f3; 
            border-radius: 50%; 
            border-top: 4px solid #6d28d9; 
            width: 40px; 
            height: 40px; 
            animation: spin 1s linear infinite; 
        }
        
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        
        .pac-container { 
            background-color: #1F2937; 
            border-radius: 8px; 
            border: 1px solid #4B5563; 
            z-index: 9999;
        }
        .pac-item { 
            padding: 10px; 
            font-size: 14px; 
            color: #D1D5DB; 
            cursor: pointer; 
            border-top: 1px solid #374151;
        }
        .pac-item:first-child { border-top: none; }
        .pac-item:hover { background-color: #374151; }
        .pac-item-query { font-weight: 600; color: #F3F4F6; }

        .toast-container { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            z-index: 1000; 
        }
        .toast { 
            background: #1f2937; 
            border-left: 4px solid; 
            color: white; 
            padding: 16px; 
            border-radius: 8px; 
            margin-bottom: 10px; 
            min-width: 300px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            transform: translateX(400px); 
            transition: all 0.3s ease;
        }
        .toast.show { transform: translateX(0); }
        .toast.success { border-left-color: #22c55e; }
        .toast.error { border-left-color: #ef4444; }
        .toast.info { border-left-color: #3b82f6; }
        .toast.warning { border-left-color: #f59e0b; }

        .btn-loading { 
            position: relative; 
            color: transparent !important; 
        }
        .btn-loading::after {
            content: ''; 
            position: absolute; 
            top: 50%; 
            left: 50%; 
            width: 20px; 
            height: 20px;
            margin: -10px 0 0 -10px; 
            border: 2px solid #ffffff; 
            border-top: 2px solid transparent;
            border-radius: 50%; 
            animation: spin 1s linear infinite;
        }

        /* Stripe Elements Styling */
        .StripeElement {
            background-color: #1F2937 !important;
            color: #ffffff !important;
            padding: 12px !important;
            border-radius: 8px !important;
            border: 1px solid #4B5563 !important;
        }
        .StripeElement--focus {
            border-color: #6d28d9 !important;
            box-shadow: 0 0 0 2px rgba(109, 40, 217, 0.1) !important;
        }
        .StripeElement--invalid {
            border-color: #ef4444 !important;
        }

        .ride-status-card {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, #000000, #1a1a1a);
            border-top: 2px solid #6d28d9;
            padding: 20px;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 50;
        }
        .ride-status-card.show {
            transform: translateY(0);
        }

        .error-banner {
            background: linear-gradient(to right, #dc2626, #b91c1c);
            color: white;
            padding: 12px;
            text-align: center;
            font-size: 14px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 9999;
            display: none;
        }

        .offline-indicator {
            background: #f59e0b;
            color: white;
            padding: 8px;
            text-align: center;
            font-size: 12px;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 9999;
            display: none;
        }

        @media (max-width: 640px) {
            .container { 
                padding: 16px; 
            }
            .toast { 
                min-width: auto; 
                max-width: calc(100vw - 40px); 
            }
        }

        /* Fallback CSS for quando Tailwind n√£o carrega */
        .fallback-styles {
            .w-full { width: 100%; }
            .h-20 { height: 5rem; }
            .bg-black { background-color: #000000; }
            .bg-purple-600 { background-color: #7c3aed; }
            .bg-gray-800 { background-color: #1f2937; }
            .text-white { color: #ffffff; }
            .text-center { text-align: center; }
            .rounded-lg { border-radius: 0.5rem; }
            .p-4 { padding: 1rem; }
            .mb-4 { margin-bottom: 1rem; }
            .flex { display: flex; }
            .items-center { align-items: center; }
            .justify-center { justify-content: center; }
            .min-h-screen { min-height: 100vh; }
            .max-w-md { max-width: 28rem; }
            .mx-auto { margin-left: auto; margin-right: auto; }
            .space-y-4 > * + * { margin-top: 1rem; }
            .px-4 { padding-left: 1rem; padding-right: 1rem; }
            .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
            .border { border-width: 1px; }
            .border-gray-600 { border-color: #4b5563; }
            .focus\:ring-2:focus { box-shadow: 0 0 0 2px; }
            .focus\:ring-purple-500:focus { box-shadow: 0 0 0 2px #8b5cf6; }
            .hover\:bg-purple-700:hover { background-color: #6d28d9; }
            .font-semibold { font-weight: 600; }
            .font-bold { font-weight: 700; }
            .text-xl { font-size: 1.25rem; }
            .text-lg { font-size: 1.125rem; }
            .text-sm { font-size: 0.875rem; }
            .text-2xl { font-size: 1.5rem; }
            .text-3xl { font-size: 1.875rem; }
        }
    </style>
</head>
<body>

    <!-- Error Banner -->
    <div id="error-banner" class="error-banner">
        ‚ö†Ô∏è Problemas de conectividade detectados. Algumas funcionalidades podem estar limitadas.
    </div>

    <!-- Offline Indicator -->
    <div id="offline-indicator" class="offline-indicator">
        üì∂ Voc√™ est√° offline. Reconectando...
    </div>

    <!-- Toast Container -->
    <div class="toast-container"></div>

    <!-- Loading Screen -->
    <div id="loading-screen" class="screen active">
        <div class="min-h-screen bg-black flex items-center justify-center">
            <div class="text-center">
                <div class="w-20 h-20 bg-purple-600 rounded-2xl mx-auto mb-6 flex items-center justify-center">
                    <span class="text-2xl font-bold text-white">GM</span>
                </div>
                <div class="loader mx-auto mb-4"></div>
                <p class="text-gray-300">Carregando Garcia Mobilidade...</p>
                <p id="loading-status" class="text-gray-500 text-sm mt-2">Verificando conex√µes...</p>
            </div>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="login-screen" class="screen">
        <div class="min-h-screen bg-black flex items-center justify-center px-4">
            <div class="w-full max-w-md">
                <div class="text-center mb-8">
                    <div class="w-20 h-20 bg-purple-600 rounded-2xl mx-auto mb-4 flex items-center justify-center">
                        <span class="text-2xl font-bold text-white">GM</span>
                    </div>
                    <h1 class="text-3xl font-bold text-white">Login</h1>
                </div>

                <!-- Connection Status -->
                <div id="connection-status" class="mb-4 p-3 rounded-lg text-center text-sm" style="display: none;">
                    <span id="connection-text">Verificando conex√£o...</span>
                </div>

                <!-- Social Login -->
                <div class="space-y-3 mb-6">
                    <button onclick="handleSignInWithProvider('google')" class="w-full py-3 font-semibold rounded-lg bg-white text-gray-800 hover:bg-gray-200 flex items-center justify-center gap-2">
                        <span>üîç</span> Entrar com Google
                    </button>
                    <button onclick="handleSignInWithProvider('facebook')" class="w-full py-3 font-semibold rounded-lg bg-blue-600 text-white hover:bg-blue-700 flex items-center justify-center gap-2">
                        <span>üìò</span> Entrar com Facebook
                    </button>
                </div>

                <div class="text-center text-gray-400 mb-6">OU</div>

                <!-- Email Login Form -->
                <form id="login-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">E-mail</label>
                        <input type="email" id="login-email" value="luciano.emobile.consultoria@gmail.co" class="w-full px-4 py-3 bg-gray-800 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Senha</label>
                        <input type="password" id="login-password" value="123456" class="w-full px-4 py-3 bg-gray-800 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
                    </div>
                    <button type="submit" id="login-btn" class="w-full py-3 font-semibold rounded-lg bg-purple-600 text-white hover:bg-purple-700">
                        ENTRAR
                    </button>
                </form>

                <div class="text-center mt-6">
                    <button onclick="showScreen('forgot-password-screen')" class="text-purple-400 hover:text-purple-300 text-sm">Esqueceu a senha?</button>
                </div>
                <div class="text-center mt-4">
                    <span class="text-gray-400 text-sm">N√£o tem uma conta? </span>
                    <button onclick="showScreen('signup-screen')" class="text-purple-400 hover:text-purple-300 text-sm font-semibold">Cadastre-se</button>
                </div>
            </div>
        </div>
    </div>

    <!-- User Screen -->
    <div id="user-screen" class="screen">
        <div class="min-h-screen bg-black">
            <!-- Header -->
            <div class="bg-gradient-to-r from-purple-600 to-purple-800 p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 id="welcome-message" class="text-xl font-bold text-white">Ol√°, Usu√°rio!</h1>
                        <p class="text-purple-200 text-sm">Onde voc√™ quer ir hoje?</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-purple-200">Saldo</p>
                        <p id="wallet-balance-display" class="text-lg font-bold text-white">R$ 0,00</p>
                    </div>
                </div>
            </div>

            <!-- Trip Form -->
            <div class="p-4 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">De onde voc√™ est√° saindo?</label>
                    <div class="relative">
                        <input type="text" id="origin" placeholder="Digite o endere√ßo de origem" class="w-full px-4 py-3 bg-gray-800 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <button onclick="useCurrentLocation()" class="absolute right-3 top-3 text-purple-400 hover:text-purple-300">
                            üìç
                        </button>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Para onde voc√™ vai?</label>
                    <input type="text" id="destination" placeholder="Digite o endere√ßo de destino" class="w-full px-4 py-3 bg-gray-800 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>

                <button onclick="requestRide()" class="w-full py-4 font-semibold rounded-lg bg-purple-600 text-white hover:bg-purple-700 text-lg">
                    SOLICITAR VIAGEM
                </button>
            </div>

            <!-- Quick Actions -->
            <div class="p-4">
                <h3 class="text-lg font-semibold text-white mb-4">A√ß√µes R√°pidas</h3>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="showWalletScreen()" class="p-4 bg-gray-800 rounded-lg hover:bg-gray-700 text-center">
                        <div class="text-2xl mb-2">üí≥</div>
                        <div class="text-sm text-gray-300">Carteira</div>
                    </button>
                    <button onclick="showHistoryScreen()" class="p-4 bg-gray-800 rounded-lg hover:bg-gray-700 text-center">
                        <div class="text-2xl mb-2">üìã</div>
                        <div class="text-sm text-gray-300">Hist√≥rico</div>
                    </button>
                    <button onclick="showProfileScreen()" class="p-4 bg-gray-800 rounded-lg hover:bg-gray-700 text-center">
                        <div class="text-2xl mb-2">üë§</div>
                        <div class="text-sm text-gray-300">Perfil</div>
                    </button>
                    <button onclick="handleSignOut()" class="p-4 bg-gray-800 rounded-lg hover:bg-gray-700 text-center">
                        <div class="text-2xl mb-2">üö™</div>
                        <div class="text-sm text-gray-300">Sair</div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== CONFIGURA√á√ïES E FALLBACKS ==========
        const SUPABASE_URL = 'https://kcdjbagmffwfpqwgxbqg.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtjZGpiYWdtZmZ3ZnBxd2d4YnFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjgwNzk1NDYsImV4cCI6MjA0MzY1NTU0Nn0.bHHlqGXMz0IylZFmL0OLKQe9v7cL-ZPAjhWNqcx85I8';
        const STRIPE_PUBLISHABLE_KEY = 'pk_test_51SEJCBFyO4P04UV0YubwfXu6UD8rmVBuA1AGNlygxvLTTiVCfdnmaAewkyT7H1mfgMBu0JhpvPPbraIC2IIM080G00KH08HO7v';

        // Estado da aplica√ß√£o
        const state = {
            user: null,
            profile: null,
            currentRide: null,
            originPlace: null,
            destinationPlace: null,
            rideSubscription: null,
            topUpAmount: 0,
            isOnline: navigator.onLine,
            servicesStatus: {
                supabase: false,
                stripe: false,
                googleMaps: false,
                tailwind: false
            }
        };

        // Vari√°veis globais
        let supabaseClient = null;
        let stripe = null;
        let elements = null;
        let cardElement = null;

        // ========== TRATAMENTO DE ERROS E FALLBACKS ==========
        function handleCDNError(service) {
            console.warn(`‚ö†Ô∏è Falha ao carregar ${service}`);
            state.servicesStatus[service] = false;
            updateConnectionStatus();
            
            if (service === 'tailwind') {
                document.body.classList.add('fallback-styles');
            }
        }

        function updateConnectionStatus() {
            const statusElement = document.getElementById('connection-status');
            const textElement = document.getElementById('connection-text');
            
            if (!statusElement || !textElement) return;

            const offlineServices = Object.keys(state.servicesStatus).filter(
                service => !state.servicesStatus[service]
            );

            if (offlineServices.length > 0) {
                statusElement.style.display = 'block';
                statusElement.style.backgroundColor = '#f59e0b';
                textElement.textContent = `‚ö†Ô∏è Servi√ßos limitados: ${offlineServices.join(', ')}`;
                document.getElementById('error-banner').style.display = 'block';
            } else {
                statusElement.style.display = 'block';
                statusElement.style.backgroundColor = '#059669';
                textElement.textContent = '‚úÖ Todos os servi√ßos online';
                document.getElementById('error-banner').style.display = 'none';
            }
        }

        // ========== INICIALIZA√á√ÉO ROBUSTA ==========
        async function initializeApp() {
            console.log('üöÄ Inicializando Garcia Mobilidade (Vers√£o Robusta)...');
            updateLoadingStatus('Verificando conex√µes...');
            
            // Verificar conectividade b√°sica
            await checkConnectivity();
            
            // Inicializar servi√ßos com tratamento de erro
            await initializeSupabase();
            await initializeStripe();
            await checkGoogleMaps();
            
            updateLoadingStatus('Verificando sess√£o do usu√°rio...');
            
            // Verificar sess√£o do usu√°rio
            await checkUserSession();
            
            // Configurar listeners
            setupEventListeners();
            setupNetworkListeners();
            
            updateLoadingStatus('Conclu√≠do!');
            setTimeout(() => {
                document.getElementById('loading-screen').classList.remove('active');
            }, 1000);
        }

        async function checkConnectivity() {
            try {
                updateLoadingStatus('Testando conectividade...');
                const response = await fetch('https://www.google.com/favicon.ico', { 
                    method: 'HEAD',
                    mode: 'no-cors',
                    cache: 'no-cache'
                });
                state.isOnline = true;
                console.log('‚úÖ Conectividade confirmada');
            } catch (error) {
                state.isOnline = false;
                console.warn('‚ö†Ô∏è Problemas de conectividade detectados');
                showOfflineMode();
            }
        }

        async function initializeSupabase() {
            try {
                updateLoadingStatus('Conectando ao Supabase...');
                
                if (typeof supabase === 'undefined') {
                    throw new Error('Supabase n√£o carregado');
                }
                
                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                    auth: {
                        persistSession: true,
                        autoRefreshToken: true,
                        detectSessionInUrl: true
                    },
                    global: {
                        headers: {
                            'X-Client-Info': 'garcia-mobilidade@1.0.0'
                        }
                    }
                });
                
                // Testar conex√£o
                const { data, error } = await supabaseClient.auth.getSession();
                if (error && error.message.includes('Failed to fetch')) {
                    throw new Error('Erro de conectividade com Supabase');
                }
                
                state.servicesStatus.supabase = true;
                console.log('‚úÖ Supabase inicializado');
                updateConnectionStatus();
                
            } catch (error) {
                console.error('‚ùå Erro ao inicializar Supabase:', error);
                state.servicesStatus.supabase = false;
                updateConnectionStatus();
                toast.show('Problemas de conectividade com o servidor. Algumas funcionalidades podem estar limitadas.', 'warning');
            }
        }

        async function initializeStripe() {
            try {
                updateLoadingStatus('Carregando sistema de pagamento...');
                
                if (typeof Stripe === 'undefined') {
                    throw new Error('Stripe n√£o carregado');
                }
                
                stripe = Stripe(STRIPE_PUBLISHABLE_KEY);
                state.servicesStatus.stripe = true;
                console.log('‚úÖ Stripe inicializado');
                
            } catch (error) {
                console.error('‚ùå Erro ao inicializar Stripe:', error);
                state.servicesStatus.stripe = false;
                toast.show('Sistema de pagamento n√£o dispon√≠vel.', 'warning');
            }
        }

        function checkGoogleMaps() {
            updateLoadingStatus('Verificando Google Maps...');
            
            if (typeof google !== 'undefined' && google.maps) {
                state.servicesStatus.googleMaps = true;
                console.log('‚úÖ Google Maps dispon√≠vel');
                initializeGoogleMaps();
            } else {
                console.warn('‚ö†Ô∏è Google Maps n√£o dispon√≠vel');
                state.servicesStatus.googleMaps = false;
            }
            updateConnectionStatus();
        }

        // Callback global para Google Maps
        window.initGoogleMaps = function() {
            console.log('üó∫Ô∏è Google Maps carregado via callback');
            state.servicesStatus.googleMaps = true;
            updateConnectionStatus();
            
            // Inicializar apenas se estiver na tela do usu√°rio
            if (document.getElementById('user-screen').classList.contains('active')) {
                initializeGoogleMaps();
            }
        };

        async function checkUserSession() {
            if (!supabaseClient) {
                console.warn('‚ö†Ô∏è Supabase n√£o dispon√≠vel para verificar sess√£o');
                showScreen('login-screen');
                return;
            }

            try {
                const { data: { session }, error } = await supabaseClient.auth.getSession();
                
                if (error) {
                    console.error('‚ùå Erro ao verificar sess√£o:', error);
                    showScreen('login-screen');
                    return;
                }
                
                if (session?.user) {
                    console.log('üë§ Sess√£o ativa encontrada:', session.user.email);
                    state.user = session.user;
                    try {
                        await loadUserProfile(session.user.id);
                    } catch (profileError) {
                        console.error('‚ùå Erro ao carregar perfil:', profileError);
                        showScreen('login-screen');
                    }
                } else {
                    console.log('üë§ Nenhuma sess√£o ativa');
                    showScreen('login-screen');
                }
                
            } catch (error) {
                console.error('‚ùå Erro cr√≠tico ao verificar sess√£o:', error);
                showScreen('login-screen');
            }
        }

        function updateLoadingStatus(message) {
            const statusElement = document.getElementById('loading-status');
            if (statusElement) {
                statusElement.textContent = message;
            }
        }

        // ========== NAVEGA√á√ÉO ENTRE TELAS ==========
        function showScreen(screenId) {
            // Remover classe active de todas as telas
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            // Mostrar tela solicitada
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.add('active');
                console.log('üîÑ Tela ativa:', screenId);
                
                // Inicializar Google Maps se estiver indo para user-screen
                if (screenId === 'user-screen' && state.servicesStatus.googleMaps) {
                    setTimeout(initializeGoogleMaps, 500);
                }
            } else {
                console.error('‚ùå Tela n√£o encontrada:', screenId);
            }
        }

        function showLoading(buttonId) {
            const button = document.getElementById(buttonId);
            if (button) {
                button.classList.add('btn-loading');
                button.disabled = true;
            }
        }

        function hideLoading(buttonId) {
            const button = document.getElementById(buttonId);
            if (button) {
                button.classList.remove('btn-loading');
                button.disabled = false;
            }
        }

        // ========== SISTEMA DE TOAST ==========
        const toast = {
            show: function(message, type = 'info') {
                const container = document.querySelector('.toast-container');
                if (!container) return;
                
                const toastElement = document.createElement('div');
                toastElement.className = `toast ${type}`;
                toastElement.innerHTML = `<div>${message}</div>`;
                
                container.appendChild(toastElement);
                
                setTimeout(() => {
                    toastElement.classList.add('show');
                }, 100);
                
                setTimeout(() => {
                    toastElement.classList.remove('show');
                    setTimeout(() => {
                        if (container.contains(toastElement)) {
                            container.removeChild(toastElement);
                        }
                    }, 300);
                }, 4000);
            }
        };

        // ========== AUTENTICA√á√ÉO ROBUSTA ==========
        async function handleSignIn(email, password) {
            if (!supabaseClient) {
                toast.show('Sistema de autentica√ß√£o n√£o dispon√≠vel. Tente recarregar a p√°gina.', 'error');
                return;
            }

            showLoading('login-btn');
            
            try {
                console.log('üîê Tentando fazer login...');
                
                const { data, error } = await supabaseClient.auth.signInWithPassword({ 
                    email, 
                    password 
                });
                
                if (error) {
                    console.error('‚ùå Erro no login:', error);
                    
                    // Tratar diferentes tipos de erro
                    if (error.message.includes('Invalid login credentials')) {
                        toast.show('E-mail ou senha incorretos.', 'error');
                    } else if (error.message.includes('Network')) {
                        toast.show('Problemas de conectividade. Tente novamente.', 'error');
                    } else {
                        toast.show(`Erro no login: ${error.message}`, 'error');
                    }
                    return;
                }
                
                if (data?.user) {
                    console.log('‚úÖ Login realizado com sucesso:', data.user.email);
                    state.user = data.user;
                    toast.show('Login realizado com sucesso!', 'success');
                    
                    // Carregar perfil com retry
                    try {
                        await loadUserProfileWithRetry(data.user.id);
                    } catch (profileError) {
                        console.error('‚ùå Erro ao carregar perfil:', profileError);
                        toast.show('Login realizado, mas houve problemas ao carregar dados do perfil.', 'warning');
                        showScreen('user-screen');
                    }
                } else {
                    toast.show('Erro inesperado no login. Tente novamente.', 'error');
                }
                
            } catch (error) {
                console.error('‚ùå Erro cr√≠tico no login:', error);
                
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    toast.show('Problemas de conectividade. Verifique sua internet e tente novamente.', 'error');
                } else {
                    toast.show('Erro inesperado. Tente recarregar a p√°gina.', 'error');
                }
            } finally {
                hideLoading('login-btn');
            }
        }

        async function loadUserProfile(userId) {
            if (!supabaseClient) {
                throw new Error('Supabase n√£o dispon√≠vel');
            }

            console.log('üîÑ Carregando perfil do usu√°rio:', userId);
            
            try {
                const { data, error } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('id', userId)
                    .single();
                    
                if (error && error.code !== 'PGRST116') {
                    console.error('‚ùå Erro na consulta do perfil:', error);
                    throw error;
                }
                
                if (!data) {
                    console.log('üìÑ Criando perfil b√°sico para o usu√°rio');
                    const userEmail = state.user?.email || 'Usu√°rio';
                    state.profile = {
                        id: userId,
                        full_name: userEmail.split('@')[0],
                        email: userEmail,
                        wallet_balance: 0
                    };
                } else {
                    state.profile = data;
                }
                
                updateUserInterface();
                console.log('‚úÖ Perfil carregado com sucesso');
                showScreen('user-screen');
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar perfil:', error);
                
                // Criar perfil m√≠nimo de emerg√™ncia
                const userEmail = state.user?.email || 'Usu√°rio';
                state.profile = {
                    id: userId,
                    full_name: userEmail.split('@')[0],
                    email: userEmail,
                    wallet_balance: 0
                };
                
                updateUserInterface();
                showScreen('user-screen');
                throw error; // Re-throw para tratamento upstream
            }
        }

        async function loadUserProfileWithRetry(userId, maxRetries = 3) {
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    await loadUserProfile(userId);
                    return; // Sucesso
                } catch (error) {
                    console.warn(`‚ö†Ô∏è Tentativa ${attempt}/${maxRetries} falhou ao carregar perfil:`, error);
                    
                    if (attempt === maxRetries) {
                        throw error; // √öltima tentativa falhou
                    }
                    
                    // Esperar antes da pr√≥xima tentativa
                    await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
                }
            }
        }

        function updateUserInterface() {
            if (!state.profile) return;
            
            const welcomeMsg = document.getElementById('welcome-message');
            const walletDisplay = document.getElementById('wallet-balance-display');
            const walletDetails = document.getElementById('wallet-balance-details');
            
            if (welcomeMsg) {
                welcomeMsg.textContent = `Ol√°, ${state.profile.full_name}!`;
            }
            if (walletDisplay) {
                walletDisplay.textContent = formatCurrency(state.profile.wallet_balance || 0);
            }
            if (walletDetails) {
                walletDetails.textContent = formatCurrency(state.profile.wallet_balance || 0);
            }
        }

        async function handleSignOut() {
            try {
                if (supabaseClient) {
                    await supabaseClient.auth.signOut();
                }
                
                state.user = null;
                state.profile = null;
                state.currentRide = null;
                
                toast.show('Logout realizado com sucesso', 'success');
                showScreen('login-screen');
            } catch (error) {
                console.error('‚ùå Erro ao fazer logout:', error);
                toast.show('Erro ao fazer logout, mas voc√™ foi desconectado localmente.', 'warning');
                showScreen('login-screen');
            }
        }

        // ========== GOOGLE MAPS ==========
        function initializeGoogleMaps() {
            if (!state.servicesStatus.googleMaps || typeof google === 'undefined' || !google.maps) {
                console.warn('‚ö†Ô∏è Google Maps n√£o est√° dispon√≠vel');
                return;
            }

            try {
                const originInput = document.getElementById('origin');
                const destinationInput = document.getElementById('destination');

                if (originInput) {
                    const originAutocomplete = new google.maps.places.Autocomplete(originInput);
                    originAutocomplete.addListener('place_changed', () => {
                        const place = originAutocomplete.getPlace();
                        if (place.geometry) {
                            state.originPlace = place;
                            console.log('üìç Origem selecionada:', place.formatted_address);
                        }
                    });
                }

                if (destinationInput) {
                    const destinationAutocomplete = new google.maps.places.Autocomplete(destinationInput);
                    destinationAutocomplete.addListener('place_changed', () => {
                        const place = destinationAutocomplete.getPlace();
                        if (place.geometry) {
                            state.destinationPlace = place;
                            console.log('üìç Destino selecionado:', place.formatted_address);
                        }
                    });
                }
                
                console.log('üó∫Ô∏è Google Maps Autocomplete inicializado');
                
            } catch (error) {
                console.error('‚ùå Erro ao inicializar Google Maps:', error);
                state.servicesStatus.googleMaps = false;
                updateConnectionStatus();
            }
        }

        function useCurrentLocation() {
            if (!navigator.geolocation) {
                toast.show('Geolocaliza√ß√£o n√£o √© suportada neste navegador.', 'error');
                return;
            }

            const originInput = document.getElementById('origin');
            originInput.value = 'Obtendo localiza√ß√£o...';
            state.originPlace = null;

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { latitude: lat, longitude: lng } = position.coords;
                    
                    if (state.servicesStatus.googleMaps && typeof google !== 'undefined' && google.maps) {
                        const latLng = new google.maps.LatLng(lat, lng);
                        const geocoder = new google.maps.Geocoder();
                        
                        geocoder.geocode({ 'location': latLng }, (results, status) => {
                            if (status === 'OK' && results[0]) {
                                originInput.value = results[0].formatted_address;
                                state.originPlace = {
                                    formatted_address: results[0].formatted_address,
                                    geometry: { location: latLng }
                                };
                                toast.show('Localiza√ß√£o obtida com sucesso!', 'success');
                            } else {
                                originInput.value = `Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}`;
                                toast.show('Localiza√ß√£o obtida (coordenadas)', 'info');
                            }
                        });
                    } else {
                        originInput.value = `Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}`;
                        toast.show('Localiza√ß√£o obtida (coordenadas)', 'info');
                    }
                },
                (error) => {
                    console.error('‚ùå Erro de geolocaliza√ß√£o:', error);
                    toast.show('N√£o foi poss√≠vel obter sua localiza√ß√£o.', 'error');
                    originInput.value = '';
                }
            );
        }

        // ========== VIAGENS ==========
        async function requestRide() {
            const originInput = document.getElementById('origin');
            const destinationInput = document.getElementById('destination');
            
            if (!originInput.value || !destinationInput.value) {
                toast.show('Por favor, preencha origem e destino.', 'warning');
                return;
            }

            if (!supabaseClient) {
                toast.show('Sistema n√£o dispon√≠vel no momento. Tente novamente.', 'error');
                return;
            }

            try {
                const { data: ride, error } = await supabaseClient
                    .from('rides')
                    .insert([{
                        user_id: state.user.id,
                        origin: originInput.value,
                        destination: destinationInput.value,
                        status: 'requested',
                        estimated_price: 15.00,
                        created_at: new Date().toISOString()
                    }])
                    .select()
                    .single();

                if (error) throw error;

                state.currentRide = ride;
                toast.show('Viagem solicitada! Procurando motorista...', 'success');
                
            } catch (error) {
                console.error('‚ùå Erro ao solicitar viagem:', error);
                toast.show('Erro ao solicitar viagem: ' + error.message, 'error');
            }
        }

        // ========== LISTENERS DE REDE ==========
        function setupNetworkListeners() {
            window.addEventListener('online', () => {
                console.log('üåê Conex√£o restaurada');
                state.isOnline = true;
                hideOfflineMode();
                toast.show('Conex√£o restaurada!', 'success');
                
                // Reinicializar servi√ßos se necess√°rio
                if (!supabaseClient) {
                    initializeSupabase();
                }
            });

            window.addEventListener('offline', () => {
                console.log('üì¥ Conex√£o perdida');
                state.isOnline = false;
                showOfflineMode();
                toast.show('Voc√™ est√° offline. Algumas funcionalidades podem n√£o funcionar.', 'warning');
            });
        }

        function showOfflineMode() {
            document.getElementById('offline-indicator').style.display = 'block';
        }

        function hideOfflineMode() {
            document.getElementById('offline-indicator').style.display = 'none';
        }

        // ========== EVENT LISTENERS ==========
        function setupEventListeners() {
            // Auth state listener (apenas se Supabase estiver dispon√≠vel)
            if (supabaseClient) {
                supabaseClient.auth.onAuthStateChange(async (event, session) => {
                    console.log('üîÑ Mudan√ßa de autentica√ß√£o:', event, session?.user?.id);
                    
                    if (event === 'SIGNED_IN' && session?.user) {
                        if (!state.user || state.user.id !== session.user.id) {
                            console.log('üë§ Novo login detectado via listener');
                            state.user = session.user;
                            try {
                                await loadUserProfile(session.user.id);
                            } catch (error) {
                                console.error('‚ùå Erro no listener de autentica√ß√£o:', error);
                            }
                        }
                    } else if (event === 'SIGNED_OUT') {
                        console.log('üö™ Logout detectado');
                        state.user = null;
                        state.profile = null;
                        showScreen('login-screen');
                    }
                });
            }

            // Form listeners
            const loginForm = document.getElementById('login-form');
            if (loginForm) {
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = document.getElementById('login-email').value;
                    const password = document.getElementById('login-password').value;
                    await handleSignIn(email, password);
                });
            }
        }

        // ========== TELAS ADICIONAIS ==========
        function showWalletScreen() {
            if (!state.servicesStatus.stripe) {
                toast.show('Sistema de pagamento n√£o dispon√≠vel no momento.', 'error');
                return;
            }
            toast.show('Carteira em desenvolvimento', 'info');
        }

        function showHistoryScreen() {
            toast.show('Hist√≥rico em desenvolvimento', 'info');
        }

        function showProfileScreen() {
            toast.show('Perfil em desenvolvimento', 'info');
        }

        // ========== UTILS ==========
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }

        // ========== INICIALIZA√á√ÉO ==========
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }

        console.log('üéÆ Garcia Mobilidade - Vers√£o Ultra Robusta Carregada');

    </script>
</body>
</html>
